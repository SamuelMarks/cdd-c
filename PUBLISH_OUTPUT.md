# Publishing the OpenAPI Client Library (cdd-c)

This document describes how to automate the publication and updates of a client library generated by `cdd-c` to stay in sync with a server's OpenAPI specification.

## Automated Updates via GitHub Actions

To ensure the client library is always up-to-date with the upstream API, you can set up a GitHub Action to run periodically (e.g., via a `cron` schedule) or be triggered by a webhook when the server OpenAPI spec changes.

### Step 1: Create a GitHub Action Workflow

Create a new file in your `.github/workflows/` directory, for example, `.github/workflows/update-client.yml`:

```yaml
name: Update OpenAPI Client Library

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering
  repository_dispatch:
    types: [openapi-updated] # Allow triggering via webhook

jobs:
  update-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential curl

      - name: Build cdd-c CLI
        run: |
          cmake -S . -B build -DC_CDD_BUILD_TESTING=OFF
          cmake --build build --target c_cdd_cli

      - name: Fetch Latest OpenAPI Spec
        run: |
          # Replace with the actual URL to your OpenAPI spec
          curl -sSL https://api.example.com/openapi.json -o latest_openapi.json

      - name: Generate Client Library
        run: |
          # Run the cdd-c CLI to generate the updated client code
          # Adjust the command based on actual cdd-c CLI usage
          ./build/bin/c_cdd_cli --input latest_openapi.json --output generated_client/

      - name: Check for Changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain generated_client/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Updates
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add generated_client/
          git commit -m "Automated update: Sync client library with latest OpenAPI spec"
          git push
```

### Explanation of the Workflow:

1.  **Triggers (`on`):**
    *   `schedule`: Runs daily via `cron: '0 0 * * *'`.
    *   `workflow_dispatch`: Allows you to manually click a button in the GitHub UI to run the update.
    *   `repository_dispatch`: Allows the server holding the OpenAPI spec to send a webhook to GitHub to trigger this action immediately after the spec is updated.

2.  **Checkout & Setup:** Checks out the code and installs `cmake` and other dependencies needed to build `cdd-c`.

3.  **Build CLI:** Compiles the `c_cdd_cli` executable.

4.  **Fetch Spec:** Uses `curl` to download the newest `openapi.json` from the target server.

5.  **Generate Client:** Runs the built `c_cdd_cli` against the downloaded spec to overwrite the existing files in the `generated_client/` directory. *(Note: Adjust the CLI flags according to cdd-c's exact CLI signature).*

6.  **Check Changes & Commit:** Uses `git status` to see if the newly generated files differ from what is currently in the repository. If they differ, it commits the changes and pushes them back to the repository automatically.

## Releasing the Updated Client

Once the new code is committed and pushed, another workflow can be used to tag and publish the updated library to package managers (like `vcpkg`), following the steps outlined in `PUBLISH.md`.
